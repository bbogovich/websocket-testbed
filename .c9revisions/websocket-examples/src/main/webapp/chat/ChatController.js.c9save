{"ts":1341510319675,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"ChatController = new function(){\n\tvar $this=this;\n\tvar websocket=null;\n\tvar port=8084;\n\t\n\tthis.outputContainer=null;\n\tthis.connect=function(){\n\t\topenWebSocket();\n\t}\n\tthis.disconnect = function(){\n\t\tcloseWebSocket();\n\t}\n\tthis.sendMessage=function(data){\n\t\tif(!websocket){\n\t\t\talert(\"websocket is not yet open\");\n\t\t}else{\n\t\t\twebsocket.send(\"websocket.example.chat.request.ChatMessageRequest|\"+JSON.stringify({sessionId:SESSION_ID,chatMessage:data}));\n\t\t}\n\t}\n\tfunction onMessage(/*String*/data){\n\t\tconsole.log(data);\n\t\ttry{\n\t\t\tvar message = JSON.parse(data);\n\t\t\tvar messageType = message.messageType;\n\t\t\tvar messageHandler = messageHandlers[messageType];\n\t\t\tif(typeof(messageHandler)==\"function\"){\n\t\t\t\tmessageHandler(message);\n\t\t\t}else{\n\t\t\t\tconsole.warn(\"Unregistered message type \"+message.messageType);\n\t\t\t}\n\t\t} catch(e) {\n\t\t\tconsole.warn(\"Unable to parse incoming message - \"+data+\" -- \"+e.message);\n\t\t}\n\t}\n\tfunction openWebSocket(){\n\t\tif(!window.WebSocket){\n\t\t\tconsole.log(\"native websockets are not available.\");\n\t\t\tif(window.MozWebSocket){\n\t\t\t\twindow.WebSocket = window.MozWebSocket;\n\t\t\t\topenWebSocket();\n\t\t\t\treturn;\n\t\t\t}else{\n\t\t\t\tconsole.log(\"load the flash implementation\");\n\t\t\t\twindow.WEB_SOCKET_SWF_LOCATION = \"../scripts/WebSocketMain.swf\";\n\t\t\t\twindow.WEB_SOCKET_DEBUG = true;\n\t\t\t\tloadScript(\"../scripts/swfobject.js\",function(){\n\t\t\t\t\tconsole.log(\"swfobject.js loaded\")\n\t\t\t\t\tloadScript(\"../scripts/FABridge.js\",function(){\n\t\t\t\t\t\tconsole.log(\"FABridge.js loaded\")\n\t\t\t\t\t\tloadScript(\"../scripts/web_socket.js\",function(){\n\t\t\t\t\t\t\tconsole.log(\"web_socket.js loaded\");\n\t\t\t\t\t\t\tWebSocket.__initialize();\n\t\t\t\t\t\t\tsetTimeout(openWebSocket,100);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t\tconsole.log(\"waiting for dependencies\");\n\t\t\t}\n\t\t}else{\n\t\t\tif(!websocket){\n\t\t\t\tconsole.log(\"Instantiate new WebSocket object\");\n\t\t\t\twebsocket = new WebSocket(\"ws://\"+window.location.hostname+\":\"+port);\n\t\t\t\t$this.websocket=websocket;\n\t\t\t\twebsocket.onopen = function(e){\n\t\t\t\t\twebsocketOpen=true;\n\t\t\t\t\tconsole.log(\"websocket.onopen\");\n\t\t\t\t}\n\t\t\t\twebsocket.onmessage = function(e){\n\t\t\t\t\tconsole.log(\"websocket.onmessage\");\n\t\t\t\t\tconsole.log(e);\n\t\t\t\t\tonMessage(e.data);\n\t\t\t\t}\n\t\t\t\twebsocket.onclose=function(e){\n\t\t\t\t\twebsocket=null;\n\t\t\t\t}\n\t\t\t\tconsole.log(websocket);\n\t\t\t}\n\t\t}\n\t}\t\n\n\tfunction closeWebSocket(){\n\t\tif(websocket){\n\t\t\twebsocket.close();\n\t\t}\n\t}\n\tvar messageHandlers={\n\t\t\"websocket.example.chat.response.RegistrationSuccessResponse\":function(/*Object*/message){\n\t\t\tconsole.log(\"Registration Successful\");\n\t\t},\n\t\t\"websocket.example.chat.response.InfoMessage\":function(/*Object {message:String <message>,messageType:String <messageType>}*/message){\n\t\t\tvar msgDiv=document.createElement(\"div\");\n\t\t\tmsgDiv.appendChild(document.createTextNode(message.message));\n\t\t\tmsgDiv.className = \"receivedWebSocketMessage\";\n\t\t\tvar chatWindow =document.getElementById(\"chatOutput\");\n\t\t\tchatWindow.appendChild(msgDiv);\n\t\t\tchatWindow.scrollTop = chatWindow.scrollHeight;\n\t\t},\n\t\t\"websocket.example.chat.response.UserListUpdateMessage\":function(message){\n\t\t\tvar userListSelect = document.getElementById(\"chatUserListUsers\");\n\t\t\tvar options=userListSelect.options;\n\t\t\tvar userList = message.userlist;\n\t\t\t//remove any deleted users\n\t\t\tvar sessionMap={};\n\t\t\tfor (var i=0;i<userList.length;i++){\n\t\t\t\tvar user = userList[i];\n\t\t\t\tsessionMap[user.sessionId]=1;\n\t\t\t}\n\t\t\tvar optsToRemove=[];\n\t\t\tfor (i=0;i<options.length;i++){\n\t\t\t\tvar option = options[i];\n\t\t\t\tif(!sessionMap[option.value]){\n\t\t\t\t\toptsToRemove.push(option);\n\t\t\t\t}\n\t\t\t}\n\t\t\twhile(optsToRemove.length){\n\t\t\t\tvar option = optsToRemove.pop();\n\t\t\t\toption.parentNode.removeChild(option);\n\t\t\t}\n\t\t\tsessionMap=null;\n\t\t\t//add new users\n\t\t\tfor (var i=0,ct=userList.length;i<ct;i++){\n\t\t\t\tvar user=userList[i];\n\t\t\t\tvar sessionId=user[\"sessionId\"];\n\t\t\t\tconsole.log(\"looking for user with session id \"+sessionId);\n\t\t\t\tfor (var j=0,found=false,opts=userListSelect.options,ct2=opts.length;j<ct2&&!found;j++){\n\t\t\t\t\tfound=opts[j].value==sessionId;\n\t\t\t\t}\n\t\t\t\tif(found){\n\t\t\t\t\topts[j-1].text=user.userName;\n\t\t\t\t}else{\n\t\t\t\t\tvar opt = document.createElement(\"option\");\n\t\t\t\t\topt.value=sessionId;\n\t\t\t\t\topt.text=user.userName;\n\t\t\t\t\tuserListSelect.add(opt);\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t\"websocket.example.chat.response.ChatUserMessage\":function(message){\n\t\t\tvar sendingUser=message.userName;\n\t\t\tvar messageText=message.message;\n\t\t\tvar msgDiv = document.createElement(\"div\");\n\t\t\tvar labelDiv=document.createElement(\"div\");\n\t\t\tvar textDiv = document.createElement(\"div\");\n\t\t\tvar clearDiv=document.createElement(\"div\");\n\t\t\tclearDiv.className=\"clear\";\n\t\t\tlabelDiv.className=\"label\";\n\t\t\ttextDiv.className=\"text\";\n\t\t\tmsgDiv.className=\"message\";\n\t\t\ttextDiv.appendChild(document.createTextNode(messageText));\n\t\t\tlabelDiv.appendChild(document.createTextNode(sendingUser));\n\t\t\tmsgDiv.appendChild(labelDiv);\n\t\t\tmsgDiv.appendChild(textDiv);\n\t\t\tmsgDiv.appendChild(clearDiv);\n\t\t\tvar chatWindow =document.getElementById(\"chatOutput\");\n\t\t\tchatWindow.appendChild(msgDiv);\n\t\t\tchatWindow.scrollTop = chatWindow.scrollHeight;\n\t\t}\n\t};\n\tthis.register=function(username){\n\t\tif(websocket){\n\t\t\twebsocket.send(\n\t\t\t\t\t\"websocket.example.chat.request.RegisterRequest|\"+\n\t\t\t\t\tJSON.stringify({\n\t\t\t\t\t\t\ttransactionId:new Date().getTime(),\n\t\t\t\t\t\t\tuserName:username,sessionId:SESSION_ID\n\t\t\t\t\t\t}));\n\t\t}\n\t}\n}"]],"start1":0,"start2":0,"length1":0,"length2":5237}]],"length":5237}
